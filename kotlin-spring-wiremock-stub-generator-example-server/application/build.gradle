plugins {
    id 'java'
    id 'org.springframework.boot'
    id 'maven-publish'
//    id 'io.github.lsd-consulting.gradle.wiremock-stub-jar' version '1.0.0-6-g21a51d5'
    id 'org.jetbrains.kotlin.jvm'
    id 'kotlin'
}

apply plugin: 'kotlin-kapt'

apply plugin: 'org.springframework.boot'

apply from: 'dependencies.gradle'

task compileStubs(type: JavaCompile) {
    JavaCompile compileJava = project.getTasksByName("compileJava", true).toArray()[0]
    classpath = compileJava.classpath
    source = project.getLayout().getBuildDirectory().dir("generated-stub-sources")
    def stubsClassesDir = file("${project.getBuildDir()}/generated-stub-classes")
    destinationDir(stubsClassesDir)
    compileJava.finalizedBy(compileStubs)
}

task stubsJar(type: Jar) {
    JavaCompile compileJavaStubs = project.getTasksByName("compileStubs", true).toArray()[0]
    setDescription('Java Wiremock stubs JAR')
    setGroup("Verification")
    archiveBaseName.convention(project.provider(project::getName))
    archiveClassifier.convention("wiremock-stubs")
    from(compileJavaStubs.getDestinationDirectory())
    dependsOn(compileJavaStubs)
    compileJavaStubs.finalizedBy(stubsJar);
    project.artifacts(artifactHandler -> artifactHandler.add("archives", stubsJar));
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java

            artifact stubsJar
            artifactId "${rootProject.name}-${project.name}"
        }
    }
}
